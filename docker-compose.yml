version: "3.9"

services:
  db:
    image: postgres:16-alpine
    container_name: app-supervision-postgres
    environment:
      POSTGRES_DB: chatdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Postgres#123
    ports:
      - "5432:5432"
    volumes:
      # Khởi tạo schema + sample data đúng như file schema.sql
      - ./src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
      # Lưu data PostgreSQL ra ngoài để không mất khi restart
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d chatdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app-supervision-app
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Dùng profile dev để lấy cấu hình gần với local
      SPRING_PROFILES_ACTIVE: dev

      # Override host DB bên trong container (dùng service name 'db' thay vì localhost)
      SPRING_R2DBC_URL: r2dbc:postgresql://db:5432/chatdb
      SPRING_R2DBC_USERNAME: postgres
      SPRING_R2DBC_PASSWORD: Postgres#123

      # Tùy chọn: chỉnh thư mục upload nếu muốn
      STORAGE_TYPE: local
    ports:
      - "8080:8080"
    volumes:
      # Map thư mục uploads ra host để xem file dễ hơn và tránh mất dữ liệu
      - ./uploads:/app/uploads

volumes:
  pgdata:


