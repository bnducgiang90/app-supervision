<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Chat App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .login-container h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-form button:hover {
            background: #5568d3;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .login-form a {
            transition: color 0.3s;
        }
        
        .login-form a:hover {
            color: #5568d3 !important;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 90vh;
        }
        
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            font-size: 20px;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .user-info {
            padding: 15px;
            background: #34495e;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .user-info h3 {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .user-info p {
            font-size: 16px;
            font-weight: 600;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }
        
        .connected {
            background: #27ae60;
        }
        
        .disconnected {
            background: #e74c3c;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-primary {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }
        
        .groups-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .group-item {
            padding: 12px;
            background: #34495e;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .group-item:hover {
            background: #3d566e;
        }
        
        .group-item.active {
            background: #3498db;
        }
        
        .group-item h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .group-item p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        /* Special styling for group members modal */
        #groupMembersModal .modal-content {
            background: #fafbfc;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Group Members List Styling */
        #groupMembersList {
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 12px;
            padding-left: 4px;
            background: #ffffff;
            border-radius: 8px;
            padding: 12px;
        }
        
        #groupMembersList::-webkit-scrollbar {
            width: 8px;
        }
        
        #groupMembersList::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        #groupMembersList::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        #groupMembersList::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #ffffff !important;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            border: 2px solid #e8ecef;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        
        .member-item:hover {
            background: #ffffff !important;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }
        
        .member-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 22px;
            margin-right: 16px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 3px solid white;
        }
        
        .member-info {
            flex: 1;
            min-width: 0;
        }
        
        .member-name {
            font-weight: 700;
            color: #0f172a;
            font-size: 16px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.2px;
        }
        
        .member-username {
            font-size: 14px;
            color: #475569;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        /* Avatar color variations for better visual distinction */
        .member-avatar.color-0 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .member-avatar.color-1 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .member-avatar.color-2 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .member-avatar.color-3 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .member-avatar.color-4 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .member-avatar.color-5 {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        
        .member-avatar.color-6 {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .member-avatar.color-7 {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }
        
        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-cancel {
            background: #95a5a6;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #7f8c8d;
        }
        
        .btn-submit {
            background: #27ae60;
            color: white;
        }
        
        .btn-submit:hover {
            background: #229954;
        }
        
        .chat-area {
            display: flex;
            flex-direction: column;
            background: #ecf0f1;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }
        
        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chat-header h2 {
            color: #2c3e50;
        }
        
        .chat-header-actions {
            display: flex;
            gap: 10px;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            max-height: 100%;
        }
        
        .messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }
        
        .message.other {
            align-self: flex-start;
            background: white;
            color: #2c3e50;
        }
        
        .message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .message .time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 4px;
        }
        
        .message img, .message video {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .attachment-container {
            position: relative;
            display: inline-block;
            margin-top: 8px;
            max-width: 300px;
        }
        
        .attachment-thumbnail {
            width: 100%;
            max-width: 300px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .attachment-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .attachment-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .attachment-container:hover .attachment-actions {
            opacity: 1;
        }
        
        .attachment-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        
        .attachment-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .attachment-info {
            font-size: 11px;
            color: rgba(255,255,255,0.8);
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .preview-content img,
        .preview-content video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        
        .preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .preview-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .preview-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .preview-info {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .input-area input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ecf0f1;
            border-radius: 24px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-area input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-area button {
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .input-area button:hover {
            background: #5568d3;
        }
        
        .input-area input[type="file"] {
            display: none;
        }
        
        .file-button {
            padding: 12px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-button:hover {
            background: #7f8c8d;
        }
        
        .file-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .file-info span {
            background: #ecf0f1;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .file-info button {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }
        
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
        }
        
        .members-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Login/Register Screen -->
    <div id="loginScreen" class="login-container">
        <div id="loginForm">
            <h1>ƒêƒÉng nh·∫≠p</h1>
            <form class="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
                <button type="submit">ƒêƒÉng nh·∫≠p</button>
                <div class="error-message" id="loginError"></div>
                <div style="text-align: center; margin-top: 15px; font-size: 14px;">
                    <span>Ch∆∞a c√≥ t√†i kho·∫£n? </span>
                    <a href="#" onclick="showRegisterForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">ƒêƒÉng k√Ω ngay</a>
                    <br>
                    <a href="#" onclick="showResetPasswordForm(); return false;" style="color: #667eea; text-decoration: none; font-size: 13px; margin-top: 10px; display: inline-block;">Qu√™n m·∫≠t kh·∫©u?</a>
                </div>
            </form>
        </div>
        
        <div id="registerForm" style="display: none;">
            <h1>ƒêƒÉng k√Ω</h1>
            <form class="login-form" onsubmit="handleRegister(event)">
                <input type="text" id="registerUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="text" id="registerDisplayName" placeholder="T√™n hi·ªÉn th·ªã" required>
                <input type="password" id="registerPassword" placeholder="M·∫≠t kh·∫©u" required>
                <input type="password" id="registerConfirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" required>
                <button type="submit">ƒêƒÉng k√Ω</button>
                <div class="error-message" id="registerError"></div>
                <div style="text-align: center; margin-top: 15px; font-size: 14px;">
                    <span>ƒê√£ c√≥ t√†i kho·∫£n? </span>
                    <a href="#" onclick="showLoginForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">ƒêƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
        
        <div id="resetPasswordForm" style="display: none;">
            <h1>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h1>
            <form class="login-form" onsubmit="handleResetPassword(event)">
                <input type="text" id="resetUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                <input type="password" id="resetNewPassword" placeholder="M·∫≠t kh·∫©u m·ªõi" required>
                <input type="password" id="resetConfirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" required>
                <button type="submit">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
                <div class="error-message" id="resetError"></div>
                <div class="success-message" id="resetSuccess"></div>
                <div style="text-align: center; margin-top: 15px; font-size: 14px;">
                    <a href="#" onclick="showLoginForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (hidden initially) -->
    <div id="mainApp" class="main-container" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Chat App</h2>
                <button class="logout-btn" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
            </div>
            
            <div id="connectionStatus" class="connection-status disconnected">
                ƒêang k·∫øt n·ªëi...
            </div>
            
            <div class="user-info">
                <h3>Ng∆∞·ªùi d√πng</h3>
                <p id="currentUsername">-</p>
            </div>
            
            <div class="section">
                <h3>
                    <span>Nh√≥m c·ªßa t√¥i</span>
                    <button class="btn-primary btn-small" onclick="showCreateGroupModal()">+ T·∫°o nh√≥m</button>
                </h3>
                <div class="groups-list" id="groupsList">
                    <!-- Groups will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-header">
                <h2 id="chatTitle">Ch·ªçn m·ªôt nh√≥m ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</h2>
                <div class="chat-header-actions" id="chatHeaderActions" style="display: none;">
                    <button class="btn-primary btn-small" onclick="showAddMemberModal()">+ Th√™m th√†nh vi√™n</button>
                    <button class="btn-primary btn-small" onclick="showGroupMembersModal()">üë• Th√†nh vi√™n</button>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <div class="empty-state">
                    <p>Ch·ªçn m·ªôt nh√≥m t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ xem tin nh·∫Øn</p>
                </div>
            </div>
            
            <div class="input-area" id="inputArea" style="display: none;">
                <input type="file" id="fileInput" accept="image/*,video/*" multiple>
                <button type="button" class="file-button" onclick="document.getElementById('fileInput').click()">
                    üìé ƒê√≠nh k√®m
                </button>
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." 
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <div class="file-info" id="fileInfo" style="display: none;"></div>
                </div>
                <button type="button" id="sendButton" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <h3>T·∫°o nh√≥m m·ªõi</h3>
            <input type="text" id="groupName" placeholder="T√™n nh√≥m" required>
            <textarea id="groupDescription" placeholder="M√¥ t·∫£ (t√πy ch·ªçn)"></textarea>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCreateGroupModal()">H·ªßy</button>
                <button class="btn-submit" onclick="createGroup()">T·∫°o nh√≥m</button>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <h3>Th√™m th√†nh vi√™n v√†o nh√≥m</h3>
            <select id="memberSelect">
                <option value="">Ch·ªçn ng∆∞·ªùi d√πng...</option>
            </select>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeAddMemberModal()">H·ªßy</button>
                <button class="btn-submit" onclick="addMemberToGroup()">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- Group Members Modal -->
    <div id="groupMembersModal" class="modal">
        <div class="modal-content">
            <h3>Th√†nh vi√™n nh√≥m</h3>
            <div id="groupMembersList" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                <p style="text-align: center; color: #666;">ƒêang t·∫£i...</p>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeGroupMembersModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal" onclick="closePreview()">
        <div class="preview-content" onclick="event.stopPropagation()">
            <button class="preview-close" onclick="closePreview()">√ó</button>
            <div id="previewMedia"></div>
            <div class="preview-info" id="previewInfo"></div>
            <div class="preview-actions">
                <button class="btn-primary" onclick="downloadPreviewFile()">‚¨áÔ∏è T·∫£i v·ªÅ</button>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API base URL from current location
        // This allows the app to work on mobile devices and other browsers
        const getApiBase = () => {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            // Use current hostname and port, or default to localhost:8080 for development
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `${protocol}//${hostname}:${port || '8080'}/api`;
            }
            return `${protocol}//${hostname}${port ? ':' + port : ''}/api`;
        };
        const API_BASE = getApiBase();
        console.log('API Base URL:', API_BASE);
        let eventSource = null;
        let currentUser = null;
        let currentGroupId = null;
        let allUsers = [];
        let displayedMessageIds = new Set(); // Track displayed messages to prevent duplicates
        let isUploading = false; // Track upload state
        let userGroups = [];
        
        // Helper function to get JWT token from localStorage
        function getAuthToken() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    return user.token || null;
                } catch (e) {
                    console.error('Error parsing user from localStorage:', e);
                    return null;
                }
            }
            return null;
        }
        
        // Helper function to create headers with Authorization token
        function getAuthHeaders(includeContentType = true) {
            const headers = {};
            if (includeContentType) {
                headers['Content-Type'] = 'application/json';
            }
            const token = getAuthToken();
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return headers;
        }
        
        // Helper function for authenticated fetch requests
        async function authenticatedFetch(url, options = {}) {
            const token = getAuthToken();
            const headers = {
                ...options.headers,
                ...(token && { 'Authorization': `Bearer ${token}` })
            };
            
            const response = await fetch(url, {
                ...options,
                headers: headers
            });
            
            // If unauthorized, clear token and redirect to login
            if (response.status === 401) {
                console.warn('Unauthorized - clearing session');
                currentUser = null;
                localStorage.removeItem('currentUser');
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                throw new Error('Session expired. Please login again.');
            }
            
            return response;
        }

        // Check if user is already logged in
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
                loadUserData();
            }
            
            // Setup file input change handler
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });
        
        // Handle file selection
        function handleFileSelect(event) {
            const files = event.target.files;
            const fileInfo = document.getElementById('fileInfo');
            
            if (files && files.length > 0) {
                let html = '';
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileSize = file.size < 1024 ? file.size + ' B' : 
                                   file.size < 1024 * 1024 ? (file.size / 1024).toFixed(2) + ' KB' : 
                                   (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                    const fileName = file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name;
                    html += `<span title="${file.name}">${fileName} (${fileSize}) <button type="button" onclick="removeFile(${i})" title="X√≥a">√ó</button></span>`;
                }
                fileInfo.innerHTML = html;
                fileInfo.style.display = 'flex';
                fileInfo.style.flexWrap = 'wrap';
                fileInfo.style.gap = '5px';
            } else {
                fileInfo.style.display = 'none';
                fileInfo.innerHTML = '';
            }
        }
        
        // Remove file from selection
        function removeFile(index) {
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            const files = Array.from(fileInput.files);
            
            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            handleFileSelect({ target: fileInput });
        }
        
        // Show group members modal
        function showGroupMembersModal() {
            if (!currentGroupId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt nh√≥m tr∆∞·ªõc');
                return;
            }
            
            const modal = document.getElementById('groupMembersModal');
            modal.classList.add('active');
            loadGroupMembers();
        }
        
        // Close group members modal
        function closeGroupMembersModal() {
            const modal = document.getElementById('groupMembersModal');
            modal.classList.remove('active');
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const groupMembersModal = document.getElementById('groupMembersModal');
            if (event.target === groupMembersModal) {
                closeGroupMembersModal();
            }
        });
        
        // Load group members
        async function loadGroupMembers() {
            if (!currentGroupId) return;
            
            const membersList = document.getElementById('groupMembersList');
            membersList.innerHTML = '<p style="text-align: center; color: #666;">ƒêang t·∫£i...</p>';
            
            try {
                const response = await authenticatedFetch(`${API_BASE}/groups/${currentGroupId}/members`);
                if (!response.ok) {
                    throw new Error('Failed to load members');
                }
                
                const members = await response.json();
                
                if (members.length === 0) {
                    membersList.innerHTML = '<p style="text-align: center; color: #666;">Nh√≥m ch∆∞a c√≥ th√†nh vi√™n n√†o</p>';
                    return;
                }
                
                let html = '';
                members.forEach((member, index) => {
                    const displayName = member.displayName || member.username || 'Unknown';
                    const initial = displayName.charAt(0).toUpperCase();
                    // Use modulo to cycle through color classes for variety
                    const colorClass = `color-${index % 8}`;
                    html += `
                        <div class="member-item">
                            <div class="member-avatar ${colorClass}">${initial}</div>
                            <div class="member-info">
                                <div class="member-name">${escapeHtml(displayName)}</div>
                                <div class="member-username">@${escapeHtml(member.username || '')}</div>
                            </div>
                        </div>
                    `;
                });
                membersList.innerHTML = html;
            } catch (error) {
                console.error('Error loading group members:', error);
                membersList.innerHTML = '<p style="text-align: center; color: #e74c3c;">L·ªói khi t·∫£i danh s√°ch th√†nh vi√™n</p>';
            }
        }

        // Show register form
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
        }
        
        // Show login form
        function showLoginForm() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
        }
        
        // Show reset password form
        function showResetPasswordForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
        }
        
        // Register handler
        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const displayName = document.getElementById('registerDisplayName').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const errorDiv = document.getElementById('registerError');
            errorDiv.style.display = 'none';

            // Validation
            if (!username || !displayName || !password || !confirmPassword) {
                errorDiv.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Register new user
                const registerResponse = await fetch(`${API_BASE}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        displayName: displayName
                    })
                });
                
                if (!registerResponse.ok) {
                    const errorText = await registerResponse.text();
                    throw new Error(errorText || 'ƒêƒÉng k√Ω th·∫•t b·∫°i');
                }
                
                const user = await registerResponse.json();
                
                // Auto login after registration
                const loginResponse = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                if (!loginResponse.ok) {
                    // Registration successful but login failed - show success message
                    errorDiv.style.color = '#27ae60';
                    errorDiv.textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.';
                    errorDiv.style.display = 'block';
                    setTimeout(() => {
                        showLoginForm();
                    }, 2000);
                    return;
                }
                
                const loggedInUser = await loginResponse.json();
                
                // Save user session
                currentUser = loggedInUser;
                localStorage.setItem('currentUser', JSON.stringify(loggedInUser));
                
                // Show main app
                showMainApp();
                loadUserData();
            } catch (error) {
                console.error('Register error:', error);
                errorDiv.style.color = '#e74c3c';
                errorDiv.textContent = error.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i';
                errorDiv.style.display = 'block';
            }
        }
        
        // Reset password handler
        async function handleResetPassword(event) {
            event.preventDefault();
            const username = document.getElementById('resetUsername').value.trim();
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            const errorDiv = document.getElementById('resetError');
            const successDiv = document.getElementById('resetSuccess');
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validation
            if (!username || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Reset password (may require authentication depending on your security policy)
                const resetResponse = await authenticatedFetch(`${API_BASE}/users/reset-password`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        username: username,
                        newPassword: newPassword
                    })
                });
                
                if (!resetResponse.ok) {
                    const errorText = await resetResponse.text();
                    throw new Error(errorText || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i');
                }
                
                // Show success message
                successDiv.textContent = 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.';
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                
                // Clear form
                document.getElementById('resetUsername').value = '';
                document.getElementById('resetNewPassword').value = '';
                document.getElementById('resetConfirmPassword').value = '';
                
                // Redirect to login after 2 seconds
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
            } catch (error) {
                console.error('Reset password error:', error);
                errorDiv.textContent = error.message || 'ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th·∫•t b·∫°i';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        }
        
        // Login handler
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';

            if (!username || !password) {
                errorDiv.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Try to login
                const loginResponse = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                if (!loginResponse.ok) {
                    const errorText = await loginResponse.text();
                    throw new Error('Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u');
                }
                
                const user = await loginResponse.json();

                // Save user session
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Clear error and show main app
                errorDiv.style.display = 'none';
                showMainApp();
                loadUserData();
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
                errorDiv.style.display = 'block';
            }
        }

        // Logout handler
        async function handleLogout() {
            try {
                // Call logout API to update user status to OFFLINE
                if (currentUser && currentUser.id) {
                    const logoutResponse = await authenticatedFetch(`${API_BASE}/users/logout/${currentUser.id}`, {
                        method: 'POST'
                    });
                    
                    if (!logoutResponse.ok) {
                        console.warn('Logout API call failed, but continuing with logout');
                    }
                }
            } catch (error) {
                console.error('Error during logout API call:', error);
                // Continue with logout even if API call fails
            } finally {
                // Close SSE connection
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                // Clear session
                currentUser = null;
                currentGroupId = null;
                localStorage.removeItem('currentUser');
                
                // Show login screen
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
                // Reset all forms
                showLoginForm();
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerDisplayName').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerConfirmPassword').value = '';
                document.getElementById('registerError').style.display = 'none';
                document.getElementById('resetUsername').value = '';
                document.getElementById('resetNewPassword').value = '';
                document.getElementById('resetConfirmPassword').value = '';
                document.getElementById('resetError').style.display = 'none';
                document.getElementById('resetSuccess').style.display = 'none';
            }
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'grid';
            document.getElementById('currentUsername').textContent = currentUser.displayName || currentUser.username;
        }

        // Load user data
        async function loadUserData() {
            await Promise.all([
                loadUserGroups(),
                loadAllUsers(),
                connectSSE()
            ]);
        }

        // Load user groups
        async function loadUserGroups() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/groups/user/${currentUser.id}`);
                if (response.ok) {
                    userGroups = await response.json();
                    renderGroups();
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        // Load all users
        async function loadAllUsers() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/users`);
                if (response.ok) {
                    allUsers = await response.json();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Render groups list
        function renderGroups() {
            const groupsList = document.getElementById('groupsList');
            if (userGroups.length === 0) {
                groupsList.innerHTML = '<p style="text-align: center; opacity: 0.7; font-size: 12px;">Ch∆∞a c√≥ nh√≥m n√†o. T·∫°o nh√≥m m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>';
                return;
            }

            groupsList.innerHTML = userGroups.map(group => `
                <div class="group-item ${group.id == currentGroupId ? 'active' : ''}" 
                     onclick="selectGroup(${group.id}, '${group.name}')">
                    <h4>${group.name}</h4>
                    <p>${group.memberCount || 0} th√†nh vi√™n</p>
                </div>
            `).join('');
        }

        // Connect to SSE
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            const url = `${API_BASE}/sse/stream?userId=${currentUser.id}`;
            eventSource = new EventSource(url);

            eventSource.addEventListener('connected', (event) => {
                updateConnectionStatus(true);
            });

            eventSource.addEventListener('new_message', (event) => {
                const data = JSON.parse(event.data);
                if (data.data.groupId == currentGroupId) {
                    // Only display if not already displayed (prevent duplicates)
                    displayMessage(data.data);
                }
            });

            eventSource.addEventListener('member_added', (event) => {
                loadUserGroups();
            });

            eventSource.addEventListener('group_created', (event) => {
                loadUserGroups();
            });

            eventSource.onerror = (error) => {
                console.error('SSE Error:', error);
                updateConnectionStatus(false);
            };
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.textContent = 'ƒê√£ k·∫øt n·ªëi';
            } else {
                status.className = 'connection-status disconnected';
                status.textContent = 'M·∫•t k·∫øt n·ªëi';
            }
        }

        // Select group
        async function selectGroup(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('chatTitle').textContent = groupName;
            document.getElementById('chatHeaderActions').style.display = 'flex';
            document.getElementById('inputArea').style.display = 'flex';
            
            // Clear displayed message IDs when switching groups
            displayedMessageIds.clear();
            
            // Reset file input when switching groups
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('fileInfo').innerHTML = '';
            
            renderGroups();
            await loadGroupMessages(groupId);
        }

        // Load group messages
        async function loadGroupMessages(groupId) {
            try {
                const response = await authenticatedFetch(`${API_BASE}/messages/group/${groupId}`);
                if (response.ok) {
                    const messages = await response.json();
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '';
                    
                    if (messages.length === 0) {
                        messagesDiv.innerHTML = '<div class="empty-state"><p>Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!</p></div>';
                    } else {
                        messages.reverse().forEach(msg => displayMessage(msg));
                        // Scroll to bottom after loading all messages
                        setTimeout(() => {
                            scrollToBottom();
                        }, 200);
                    }
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display message
        function displayMessage(message) {
            // Prevent duplicate display
            if (message.id && displayedMessageIds.has(message.id)) {
                console.log('Message already displayed, skipping:', message.id);
                return;
            }
            
            if (message.id) {
                displayedMessageIds.add(message.id);
            }
            
            const messagesDiv = document.getElementById('messages');
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            const isOwn = message.senderId == currentUser.id;
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            if (message.id) {
                messageDiv.setAttribute('data-message-id', message.id);
            }
            
            let html = '';
            if (!isOwn) {
                html += `<div class="sender">${message.senderName || 'Unknown'}</div>`;
            }
            
            if (message.content) {
                html += `<div>${escapeHtml(message.content)}</div>`;
            }
            
            if (message.attachments && message.attachments.length > 0) {
                message.attachments.forEach(att => {
                    // Use thumbnail if available, otherwise use fileUrl
                    const thumbnailUrl = att.thumbnailUrl || att.fileUrl;
                    const fileSizeMB = att.fileSize ? (att.fileSize / (1024 * 1024)).toFixed(2) : '0';
                    
                    if (att.fileType.startsWith('image/')) {
                        html += `
                            <div class="attachment-container">
                                <img src="${thumbnailUrl}" 
                                     alt="${att.fileName}" 
                                     class="attachment-thumbnail"
                                     onclick="previewAttachment('${att.fileUrl}', '${att.fileName}', 'image')">
                                <div class="attachment-actions">
                                    <button class="attachment-btn" onclick="event.stopPropagation(); previewAttachment('${att.fileUrl}', '${att.fileName}', 'image')" title="Xem">
                                        üëÅÔ∏è
                                    </button>
                                    <button class="attachment-btn" onclick="event.stopPropagation(); downloadFile('${att.fileUrl}', '${att.fileName}')" title="T·∫£i v·ªÅ">
                                        ‚¨áÔ∏è
                                    </button>
                                </div>
                                <div class="attachment-info">
                                    <span>${att.fileName}</span>
                                    <span>${fileSizeMB} MB</span>
                                </div>
                            </div>
                        `;
                    } else if (att.fileType.startsWith('video/')) {
                        // For video, use fileUrl for thumbnail (video element will show first frame)
                        const videoThumbnail = att.fileUrl;
                        html += `
                            <div class="attachment-container">
                                <video src="${videoThumbnail}" 
                                       class="attachment-thumbnail"
                                       onclick="previewAttachment('${att.fileUrl}', '${att.fileName}', 'video')"
                                       muted
                                       preload="metadata"
                                       style="object-fit: cover;">
                                </video>
                                <div class="attachment-actions">
                                    <button class="attachment-btn" onclick="event.stopPropagation(); previewAttachment('${att.fileUrl}', '${att.fileName}', 'video')" title="Xem">
                                        ‚ñ∂Ô∏è
                                    </button>
                                    <button class="attachment-btn" onclick="event.stopPropagation(); downloadFile('${att.fileUrl}', '${att.fileName}')" title="T·∫£i v·ªÅ">
                                        ‚¨áÔ∏è
                                    </button>
                                </div>
                                <div class="attachment-info">
                                    <span>${att.fileName}</span>
                                    <span>${fileSizeMB} MB</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // Other file types
                        html += `
                            <div class="attachment-container">
                                <div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 10px;">üìÑ</div>
                                    <div style="font-size: 12px; margin-bottom: 5px;">${att.fileName}</div>
                                    <div style="font-size: 11px; opacity: 0.8;">${fileSizeMB} MB</div>
                                </div>
                                <div class="attachment-actions">
                                    <button class="attachment-btn" onclick="downloadFile('${att.fileUrl}', '${att.fileName}')" title="T·∫£i v·ªÅ">
                                        ‚¨áÔ∏è T·∫£i v·ªÅ
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            // Format time safely
            const timeStr = formatMessageTime(message.createdAt);
            html += `<div class="time">${timeStr}</div>`;
            
            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            // Scroll to bottom smoothly
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }
        
        // Scroll to bottom function
        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // Send message
        async function sendMessage() {
            // Prevent multiple simultaneous uploads
            if (isUploading) {
                console.log('Upload in progress, please wait...');
                return;
            }
            
            const content = document.getElementById('messageInput').value.trim();
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const sendButton = document.getElementById('sendButton');

            if (!content && (!files || files.length === 0)) {
                return;
            }

            if (!currentGroupId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt nh√≥m tr∆∞·ªõc');
                return;
            }

            // Get original button text before any changes
            const originalButtonText = sendButton ? sendButton.textContent : 'G·ª≠i';
            
            try {
                // Show loading state
                isUploading = true;
                if (sendButton) {
                    sendButton.disabled = true;
                    sendButton.textContent = files && files.length > 0 ? `ƒêang g·ª≠i ${files.length} file...` : 'ƒêang g·ª≠i...';
                    sendButton.style.opacity = '0.6';
                }
                
                if (files && files.length > 0) {
                    console.log('Sending message with files:', files.length);
                    const formData = new FormData();
                    
                    // Default location: H√† N·ªôi, Vi·ªát Nam
                    const defaultLocation = {
                        latitude: 21.0285,
                        longitude: 105.8542,
                        locationDetail: "H√† N·ªôi, Vi·ªát Nam"
                    };
                    
                    // Try to get location from device (if available and user allows)
                    let locationData = defaultLocation;
                    if (navigator.geolocation) {
                        // Note: getCurrentPosition is async, so we'll use default for now
                        // In production, you might want to get location before sending
                        console.log('Geolocation available, but using default location for now');
                    }
                    
                    // Create messageData with infoData containing location
                    // Format: {groupId, senderId, content, messageType, infoData: {location: {latitude, longitude, locationDetail}}}
                    const messageData = {
                        groupId: parseInt(currentGroupId),
                        senderId: parseInt(currentUser.id),
                        content: content || '',
                        messageType: files[0].type.startsWith('image/') ? 'IMAGE' : 
                                    files[0].type.startsWith('video/') ? 'VIDEO' : 'TEXT',
                        infoData: {
                            location: {
                                latitude: locationData.latitude,
                                longitude: locationData.longitude,
                                locationDetail: locationData.locationDetail
                            }
                        }
                    };
                    
                    // Log messageData to console for debugging
                    console.log('=== MessageData to send ===');
                    console.log('Full messageData:', messageData);
                    console.log('JSON string:', JSON.stringify(messageData));
                    console.log('Has infoData:', !!messageData.infoData);
                    console.log('Has location:', !!messageData.infoData?.location);
                    
                    const messageJson = JSON.stringify(messageData);
                    console.log('Final JSON to append:', messageJson);
                    
                    formData.append('message', messageJson);
                    
                    for (let file of files) {
                        console.log('Adding file:', file.name, file.type, file.size);
                        formData.append('files', file);
                    }
                    
                    const token = getAuthToken();
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    const response = await fetch(`${API_BASE}/messages/upload`, {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Upload failed');
                    }
                    
                    // Get the response message and display it immediately
                    const messageResponse = await response.json();
                    console.log('File uploaded successfully:', messageResponse);
                    
                    // Display message immediately (before SSE)
                    displayMessage(messageResponse);
                } else {
                    const response = await authenticatedFetch(`${API_BASE}/messages`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            groupId: parseInt(currentGroupId),
                            senderId: parseInt(currentUser.id),
                            content: content,
                            messageType: 'TEXT'
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Send message failed');
                    }
                    
                    // Get the response message and display it immediately
                    const messageResponse = await response.json();
                    displayMessage(messageResponse);
                }
                
                // Clear inputs
                document.getElementById('messageInput').value = '';
                fileInput.value = '';
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('fileInfo').innerHTML = '';
                
                // Scroll to bottom after sending
                setTimeout(() => {
                    scrollToBottom();
                }, 100);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('G·ª≠i tin nh·∫Øn th·∫•t b·∫°i: ' + error.message);
            } finally {
                // Reset loading state - always execute
                isUploading = false;
                if (sendButton) {
                    sendButton.disabled = false;
                    sendButton.textContent = originalButtonText;
                    sendButton.style.opacity = '1';
                }
            }
        }

        // Show create group modal
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'flex';
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        // Close create group modal
        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').style.display = 'none';
        }

        // Create group
        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;

            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE}/groups`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        createdBy: currentUser.id
                    })
                });

                if (response.ok) {
                    closeCreateGroupModal();
                    await loadUserGroups();
                    alert('T·∫°o nh√≥m th√†nh c√¥ng!');
                } else {
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o nh√≥m');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('T·∫°o nh√≥m th·∫•t b·∫°i');
            }
        }

        // Show add member modal
        async function showAddMemberModal() {
            if (!currentGroupId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt nh√≥m tr∆∞·ªõc');
                return;
            }

            // Load current group members
            try {
                const response = await authenticatedFetch(`${API_BASE}/groups/${currentGroupId}/members`);
                if (response.ok) {
                    const members = await response.json();
                    const memberIds = members.map(m => m.id);
                    
                    // Filter out current user and existing members
                    const availableUsers = allUsers.filter(u => 
                        u.id != currentUser.id && !memberIds.includes(u.id)
                    );

                    const select = document.getElementById('memberSelect');
                    select.innerHTML = '<option value="">Ch·ªçn ng∆∞·ªùi d√πng...</option>' +
                        availableUsers.map(u => 
                            `<option value="${u.id}">${u.displayName || u.username}</option>`
                        ).join('');

                    document.getElementById('addMemberModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading members:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch th√†nh vi√™n');
            }
        }

        // Close add member modal
        function closeAddMemberModal() {
            document.getElementById('addMemberModal').style.display = 'none';
        }

        // Add member to group
        async function addMemberToGroup() {
            const userId = document.getElementById('memberSelect').value;

            if (!userId) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng');
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE}/groups/${currentGroupId}/members`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        role: 'MEMBER'
                    })
                });

                if (response.ok) {
                    closeAddMemberModal();
                    await loadUserGroups();
                    alert('Th√™m th√†nh vi√™n th√†nh c√¥ng!');
                } else {
                    throw new Error('Kh√¥ng th·ªÉ th√™m th√†nh vi√™n');
                }
            } catch (error) {
                console.error('Error adding member:', error);
                alert('Th√™m th√†nh vi√™n th·∫•t b·∫°i');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Format date safely
        function formatMessageTime(createdAt) {
            if (!createdAt) {
                return '--:--';
            }
            
            try {
                let date;
                
                // Handle array format [year, month, day, hour, minute, second, nanosecond]
                // This is how Jackson serializes LocalDateTime by default
                if (Array.isArray(createdAt) && createdAt.length >= 6) {
                    const [year, month, day, hour, minute, second] = createdAt;
                    date = new Date(year, month - 1, day, hour || 0, minute || 0, second || 0);
                } 
                // Handle string format (ISO 8601)
                else if (typeof createdAt === 'string') {
                    date = new Date(createdAt);
                } 
                // Handle number (timestamp)
                else if (typeof createdAt === 'number') {
                    date = new Date(createdAt);
                }
                // Try to parse as Date object
                else {
                    date = new Date(createdAt);
                }
                
                // Check if date is valid
                if (date && !isNaN(date.getTime())) {
                    return date.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    return '--:--';
                }
            } catch (e) {
                console.error('Error parsing date:', createdAt, e);
                return '--:--';
            }
        }

        // Preview attachment
        let currentPreviewUrl = '';
        let currentPreviewFileName = '';
        
        function previewAttachment(fileUrl, fileName, type) {
            currentPreviewUrl = fileUrl;
            currentPreviewFileName = fileName;
            const previewModal = document.getElementById('previewModal');
            const previewMedia = document.getElementById('previewMedia');
            const previewInfo = document.getElementById('previewInfo');
            
            previewMedia.innerHTML = '';
            previewInfo.textContent = fileName;
            
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = fileUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '80vh';
                img.style.borderRadius = '8px';
                previewMedia.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '80vh';
                video.style.borderRadius = '8px';
                previewMedia.appendChild(video);
            }
            
            previewModal.classList.add('active');
        }
        
        function closePreview() {
            const previewModal = document.getElementById('previewModal');
            previewModal.classList.remove('active');
            const previewMedia = document.getElementById('previewMedia');
            previewMedia.innerHTML = '';
            currentPreviewUrl = '';
            currentPreviewFileName = '';
        }
        
        function downloadPreviewFile() {
            if (currentPreviewUrl) {
                downloadFile(currentPreviewUrl, currentPreviewFileName);
            }
        }
        
        // Download file
        function downloadFile(fileUrl, fileName) {
            // Create a temporary anchor element
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';
            
            // Append to body, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // If direct download doesn't work, try fetch
            fetch(fileUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Download error:', error);
                    // Fallback: open in new tab
                    window.open(fileUrl, '_blank');
                });
        }
        
        // Close preview on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePreview();
            }
        });
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const createModal = document.getElementById('createGroupModal');
            const addMemberModal = document.getElementById('addMemberModal');
            if (event.target == createModal) {
                closeCreateGroupModal();
            }
            if (event.target == addMemberModal) {
                closeAddMemberModal();
            }
        }
    </script>
</body>
</html>

